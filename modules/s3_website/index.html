<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test DB - Architecture AWS</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .architecture-test {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #3498db;
        }
        
        .test-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52,152,219,0.3);
        }
        
        .test-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .load-test {
            background: #e74c3c;
        }
        
        .extended-test {
            background: #f39c12;
        }
        
        .results {
            background: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .metric-counter {
            display: inline-block;
            background: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            margin: 5px;
            font-weight: bold;
        }
        
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #856404;
        }
        
        .cost-info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            color: #0c5460;
        }
        
        .endpoint-display {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 8px 12px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        
        .running-test {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error-box {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #721c24;
        }

        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #155724;
        }
        
        .disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .cors-status {
            background: #f0f8ff;
            border: 1px solid #b0d4f1;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test des Bases de Donn√©es AWS</h1>
        <p style="text-align: center; color: #666;">
            Comparaison RDS MySQL vs Aurora Serverless V2 - G√©n√©ration de m√©triques CloudWatch
        </p>

        <div class="info-box">
            <strong>Objectif :</strong> G√©n√©rer le m√™me nombre de requ√™tes sur chaque architecture 
            pour comparer les performances dans CloudWatch
        </div>

        <!-- Architecture Classique -->
        <div class="architecture-test" id="classic-section">
            <h3>Architecture Classique (ALB + EC2 + RDS MySQL)</h3>
            <p><strong>Endpoint :</strong></p>
            <div class="endpoint-display" id="classic-endpoint">Chargement...</div>
            <div class="cors-status" id="classic-cors-status">Test CORS en cours...</div>
            
            <button class="test-button" onclick="testDB('classic')" id="classic-test-btn">
                Test Simple DB
            </button>
            <button class="test-button load-test" onclick="loadTestDB('classic')" id="classic-load-btn">
                Load Test (100 requ√™tes)
            </button>
            <button class="test-button extended-test" onclick="extendedLoadTest('classic')" id="classic-ext-btn">
                Test 5min CloudWatch (60 requ√™tes)
            </button>
            
            <div class="metric-counter" id="classic-counter">Requ√™tes: 0</div>
            <div class="metric-counter" id="classic-avg">Avg: 0ms</div>
            <div class="metric-counter" id="classic-cost" style="background: #8e44ad;">Co√ªt: 0.000‚Ç¨</div>
            
            <div class="results" id="classic-results">En attente de test...</div>
        </div>

        <!-- Architecture Serverless -->
        <div class="architecture-test" id="serverless-section">
            <h3>Architecture Serverless (CloudFront + Lambda + Aurora V2)</h3>
            <p><strong>Endpoint API :</strong></p>
            <div class="endpoint-display" id="serverless-endpoint">Chargement...</div>
            <div class="cors-status" id="serverless-cors-status">Test CORS en cours...</div>
            
            <button class="test-button" onclick="testDB('serverless')" id="serverless-test-btn">
                Test Simple DB
            </button>
            <button class="test-button load-test" onclick="loadTestDB('serverless')" id="serverless-load-btn">
                Load Test (100 requ√™tes)
            </button>
            <button class="test-button extended-test" onclick="extendedLoadTest('serverless')" id="serverless-ext-btn">
                Test 5min CloudWatch (60 requ√™tes)
            </button>
            
            <div class="metric-counter" id="serverless-counter">Requ√™tes: 0</div>
            <div class="metric-counter" id="serverless-avg">Avg: 0ms</div>
            <div class="metric-counter" id="serverless-cost" style="background: #8e44ad;">Co√ªt: 0.000‚Ç¨</div>
            
            <div class="results" id="serverless-results">En attente de test...</div>
        </div>

        <!-- Tests Comparatifs Rapides -->
        <div style="text-align: center; margin: 40px 0;">
            <button class="test-button" onclick="comparativeTest()" style="font-size: 1.2rem; padding: 20px 40px;" id="comp-test-btn">
                Test Comparatif Rapide (200 requ√™tes chacun)
            </button>
            <br><br>
            <button class="test-button extended-test" onclick="comparativeExtendedTest()" style="font-size: 1.2rem; padding: 20px 40px;" id="comp-ext-btn">
                Test Comparatif CloudWatch (5min chacun)
            </button>
        </div>

        <div class="info-box">
            <strong>M√©triques CloudWatch g√©n√©r√©es :</strong><br>
            ‚Ä¢ AWS/ApplicationELB - TargetResponseTime, RequestCount<br>
            ‚Ä¢ AWS/Lambda - Duration, Invocations, ColdStarts<br>
            ‚Ä¢ AWS/RDS - DatabaseConnections, ReadLatency (RDS)<br>
            ‚Ä¢ AWS/RDS - ACUUtilization, DatabaseConnections (Aurora)<br>
            <br>
            <strong>D√©lai :</strong> M√©triques visibles dans CloudWatch dans 1-2 minutes<br>
            <strong>Pour CloudWatch :</strong> Utilisez les tests 5min pour des m√©triques continues
        </div>
    </div>

    <script>
        // Configuration des endpoints via Terraform
        var endpoints = {
            classic: "${classique_url}",
            serverless: "${serverless_api_url}"
        };

        // Compteurs de m√©triques
        var metrics = {
            classic: { requests: 0, totalTime: 0, errors: 0, totalCost: 0 },
            serverless: { requests: 0, totalTime: 0, errors: 0, totalCost: 0 }
        };

        // Co√ªts r√©alistes par requ√™te AWS (en euros, r√©gion eu-west-3)
        var costPerRequest = {
            classic: 0.000007,    // 0.007‚Ç¨ par 1000 requ√™tes
            serverless: 0.000012  // 0.012‚Ç¨ par 1000 requ√™tes
        };

        // √âtat CORS pour chaque architecture
        var corsSupport = {
            classic: null,    // null = pas test√©, true = ok, false = non support√©
            serverless: null
        };

        // Protection anti-boucle
        var testInProgress = {
            classic: false,
            serverless: false
        };

        // √âtat de connectivit√©
        var connectivity = {
            classic: true,
            serverless: true
        };

        // Fonction utilitaire pour d√©sactiver/activer les boutons
        function setButtonsState(architecture, disabled) {
            var buttons = [
                architecture + "-test-btn",
                architecture + "-load-btn", 
                architecture + "-ext-btn"
            ];
            for (var i = 0; i < buttons.length; i++) {
                var btn = document.getElementById(buttons[i]);
                if (btn) {
                    btn.disabled = disabled;
                }
            }
        }

        // Test CORS pour une architecture
        async function testCORS(architecture) {
            console.log("üîç Test CORS pour " + architecture);
            var statusDiv = document.getElementById(architecture + "-cors-status");
            
            try {
                var testUrl = endpoints[architecture] + (architecture === "serverless" ? "?ping=1" : "/?ping=1");
                var response = await fetch(testUrl, {
                    method: "GET",
                    cache: "no-cache",
                    headers: {
                        "Accept": "application/json, text/plain, */*"
                    }
                });
                
                // Si on arrive ici sans exception, CORS fonctionne
                corsSupport[architecture] = true;
                statusDiv.textContent = "‚úÖ CORS support√© - R√©ponses compl√®tes disponibles";
                statusDiv.style.background = "#d4edda";
                statusDiv.style.borderColor = "#c3e6cb";
                statusDiv.style.color = "#155724";
                console.log("‚úÖ CORS OK pour " + architecture);
                
            } catch (error) {
                // CORS bloqu√©, on utilisera le mode d√©grad√©
                corsSupport[architecture] = false;
                statusDiv.textContent = "‚ö†Ô∏è CORS bloqu√© - Mode d√©grad√© (m√©triques temps uniquement)";
                statusDiv.style.background = "#fff3cd";
                statusDiv.style.borderColor = "#ffeaa7";
                statusDiv.style.color = "#856404";
                console.log("‚ö†Ô∏è CORS bloqu√© pour " + architecture + ": " + error.message);
            }
        }

        // Test simple de base de donn√©es avec d√©tection CORS automatique
        async function testDB(architecture) {
            if (testInProgress[architecture]) {
                console.log("Test d√©j√† en cours pour " + architecture);
                return;
            }

            if (!connectivity[architecture]) {
                alert("Architecture " + architecture + " non disponible");
                return;
            }

            testInProgress[architecture] = true;
            setButtonsState(architecture, true);
            
            var startTime = performance.now();
            var resultsDiv = document.getElementById(architecture + "-results");
            
            resultsDiv.textContent = "‚è≥ Test en cours sur " + architecture + "...";

            try {
                var testUrl;
                var timestamp = Date.now();
                
                if (architecture === "serverless") {
                    testUrl = endpoints[architecture] + "?action=select&timestamp=" + timestamp;
                } else {
                    testUrl = endpoints[architecture] + "/db-test.php?test=1&timestamp=" + timestamp;
                }

                var fetchOptions = {
                    method: "GET",
                    cache: "no-cache"
                };

                // Utilisation des CORS selon le support d√©tect√©
                if (corsSupport[architecture] === false) {
                    // Mode d√©grad√© : no-cors pour √©viter les erreurs
                    fetchOptions.mode = "no-cors";
                } else {
                    // Mode normal avec headers
                    fetchOptions.headers = {
                        "Accept": "application/json, text/plain, */*"
                    };
                }

                console.log("Requ√™te vers: " + testUrl);
                console.log("Mode CORS: " + (fetchOptions.mode || "cors"));

                var controller = new AbortController();
                var timeoutId = setTimeout(function() { controller.abort(); }, 15000);
                fetchOptions.signal = controller.signal;

                var response = await fetch(testUrl, fetchOptions);

                clearTimeout(timeoutId);
                var endTime = performance.now();
                var responseTime = Math.round(endTime - startTime);

                // Mise √† jour des m√©triques
                metrics[architecture].requests++;
                metrics[architecture].totalTime += responseTime;
                metrics[architecture].totalCost += costPerRequest[architecture];
                updateCounters(architecture);

                if (fetchOptions.mode === "no-cors") {
                    // Mode d√©grad√© - on ne peut pas lire la r√©ponse
                    displayNoCorsModeResult(architecture, responseTime);
                } else {
                    // Mode normal - on peut lire la r√©ponse
                    if (response.ok) {
                        var contentType = response.headers.get("content-type") || "";
                        var data;
                        
                        if (contentType.includes("application/json")) {
                            data = await response.json();
                            displaySuccessResult(architecture, data, responseTime);
                        } else {
                            var textData = await response.text();
                            displayTextResult(architecture, textData, responseTime, response.status);
                        }
                    } else {
                        displayErrorResult(architecture, response.status, response.statusText, responseTime);
                    }
                }

            } catch (error) {
                var responseTime = Math.round(performance.now() - startTime);
                metrics[architecture].requests++;
                if (!error.name || error.name !== "AbortError") {
                    metrics[architecture].errors++;
                }
                metrics[architecture].totalTime += responseTime;
                metrics[architecture].totalCost += costPerRequest[architecture];
                updateCounters(architecture);
                
                displayExceptionResult(architecture, error, responseTime);
            } finally {
                testInProgress[architecture] = false;
                setButtonsState(architecture, false);
            }
        }

        // Mise √† jour des compteurs
        function updateCounters(architecture) {
            var metric = metrics[architecture];
            var avgTime = metric.requests > 0 ? Math.round(metric.totalTime / metric.requests) : 0;
            
            document.getElementById(architecture + "-counter").textContent = "Requ√™tes: " + metric.requests;
            document.getElementById(architecture + "-avg").textContent = "Avg: " + avgTime + "ms";
            // Affichage correct du co√ªt total en euros avec 6 d√©cimales
            document.getElementById(architecture + "-cost").textContent = "Co√ªt: " + metric.totalCost.toFixed(6) + "‚Ç¨";
        }

        function displayNoCorsModeResult(architecture, responseTime) {
            var resultsDiv = document.getElementById(architecture + "-results");
            resultsDiv.className = "results success-box";
            resultsDiv.textContent = "‚úÖ Test effectu√© sur " + architecture + " (mode d√©grad√© CORS)\n" +
"Temps de r√©ponse: " + responseTime + "ms\n" +
"Mode: Contournement CORS - Requ√™te envoy√©e avec succ√®s\n" +
"Architecture: " + (architecture === "classic" ? "ALB‚ÜíEC2‚ÜíRDS MySQL" : "CloudFront‚ÜíLambda‚ÜíAurora V2") + "\n" +
"Timestamp: " + new Date().toLocaleTimeString() + "\n\n" +
"üìä M√©triques CloudWatch g√©n√©r√©es:\n" +
"- Temps de r√©ponse c√¥t√© serveur enregistr√©\n" +
"- Connexion base de donn√©es effectu√©e\n\n" +
"‚ÑπÔ∏è R√©ponse d√©taill√©e non disponible √† cause des restrictions CORS du navigateur.";
        }

        function displaySuccessResult(architecture, data, responseTime) {
            var resultsDiv = document.getElementById(architecture + "-results");
            resultsDiv.className = "results success-box";
            resultsDiv.textContent = "‚úÖ Test r√©ussi sur " + architecture + "\n" +
"Status: " + (data.status || "OK") + "\n" +
"Temps de r√©ponse: " + responseTime + "ms\n" +
"Query Time DB: " + (data.result ? data.result.query_time_ms || "N/A" : "N/A") + "ms\n" +
"Connection ID: " + (data.result ? data.result.connection_id || "N/A" : "N/A") + "\n" +
"Version DB: " + (data.result ? data.result.aurora_version || data.result.mysql_version || "N/A" : "N/A") + "\n" +
"Architecture: " + (architecture === "serverless" ? "CloudFront‚ÜíLambda‚ÜíAurora V2" : "ALB‚ÜíEC2‚ÜíRDS MySQL") + "\n" +
"Timestamp: " + new Date().toLocaleTimeString() + "\n\n" +
"üìä M√©triques CloudWatch g√©n√©r√©es:\n" +
"- " + (architecture === "classic" ? "ALB TargetResponseTime" : "Lambda Duration") + ": " + responseTime + "ms\n" +
"- " + (architecture === "classic" ? "RDS DatabaseConnections" : "Aurora V2 ACUUtilization") + ": +1";
        }

        function displayTextResult(architecture, textData, responseTime, status) {
            var resultsDiv = document.getElementById(architecture + "-results");
            resultsDiv.className = "results";
            resultsDiv.textContent = "‚úÖ Test effectu√© sur " + architecture + "\n" +
"Status: " + status + "\n" +
"Temps de r√©ponse: " + responseTime + "ms\n" +
"R√©ponse (texte): " + textData.substring(0, 200) + (textData.length > 200 ? "..." : "") + "\n" +
"Timestamp: " + new Date().toLocaleTimeString();
        }

        function displayErrorResult(architecture, status, statusText, responseTime) {
            var resultsDiv = document.getElementById(architecture + "-results");
            resultsDiv.className = "results error-box";
            resultsDiv.textContent = "‚ùå Erreur HTTP sur " + architecture + "\n" +
"Status: " + status + " " + statusText + "\n" +
"Temps de r√©ponse: " + responseTime + "ms\n" +
"Timestamp: " + new Date().toLocaleTimeString() + "\n\n" +
"Note: La requ√™te a g√©n√©r√© des m√©triques c√¥t√© serveur.";
        }

        function displayExceptionResult(architecture, error, responseTime) {
            var resultsDiv = document.getElementById(architecture + "-results");
            resultsDiv.className = "results error-box";
            
            var errorMsg = "Erreur de connexion";
            if (error.name === "AbortError") {
                errorMsg = "Timeout - Requ√™te annul√©e apr√®s 15s";
            } else if (error.message && error.message.includes("CORS")) {
                errorMsg = "Probl√®me CORS d√©tect√©";
            } else if (error.message && error.message.includes("fetch")) {
                errorMsg = "Erreur r√©seau";
            }
            
            resultsDiv.textContent = "‚ö†Ô∏è " + errorMsg + " sur " + architecture + "\n" +
"Temps: " + responseTime + "ms\n" +
"D√©tail: " + error.message + "\n" +
"Timestamp: " + new Date().toLocaleTimeString() + "\n\n" +
"Les m√©triques peuvent √™tre g√©n√©r√©es c√¥t√© serveur.";
        }

        // Test de charge rapide
        async function loadTestDB(architecture) {
            if (testInProgress[architecture]) {
                alert("Un test est d√©j√† en cours pour " + architecture);
                return;
            }

            if (!connectivity[architecture]) {
                alert("Architecture " + architecture + " non disponible");
                return;
            }

            var resultsDiv = document.getElementById(architecture + "-results");
            var requestCount = 100;
            
            resultsDiv.textContent = "üöÄ Load test d√©marr√© sur " + architecture + "\n" +
"Envoi de " + requestCount + " requ√™tes...\n\n‚è≥ Test en cours... 0/" + requestCount;

            setButtonsState(architecture, true);

            for (var i = 0; i < requestCount; i++) {
                setTimeout(function(index) {
                    return function() {
                        testSingleRequest(architecture, index + 1, requestCount, "rapid");
                        if (index === requestCount - 1) {
                            setTimeout(function() { setButtonsState(architecture, false); }, 1000);
                        }
                    };
                }(i), i * 50); // 50ms entre chaque requ√™te
            }
        }

        // Test de charge √©tendu pour CloudWatch
        async function extendedLoadTest(architecture) {
            if (testInProgress[architecture]) {
                alert("Un test est d√©j√† en cours pour " + architecture);
                return;
            }

            if (!connectivity[architecture]) {
                alert("Architecture " + architecture + " non disponible");
                return;
            }

            var resultsDiv = document.getElementById(architecture + "-results");
            var duration = 5 * 60;
            var interval = 5;
            var totalRequests = duration / interval;
            
            resultsDiv.textContent = "üïí Test CloudWatch 5min d√©marr√© sur " + architecture + "\n" +
totalRequests + " requ√™tes (1 toutes les " + interval + "s)\n" +
"Optimis√© pour m√©triques CloudWatch continues\n\n‚è≥ 0/" + totalRequests;

            setButtonsState(architecture, true);

            for (var i = 0; i < totalRequests; i++) {
                setTimeout(function(index) {
                    return function() {
                        testSingleRequest(architecture, index + 1, totalRequests, "extended");
                        if (index === totalRequests - 1) {
                            setTimeout(function() { setButtonsState(architecture, false); }, 1000);
                        }
                    };
                }(i), i * interval * 1000);
            }
        }

        // Test d'une seule requ√™te
        async function testSingleRequest(architecture, current, total, testType) {
            var startTime = performance.now();
            
            try {
                var testUrl;
                var timestamp = Date.now();
                
                if (architecture === "serverless") {
                    var action = testType === "extended" ? "select" : "select";
                    testUrl = endpoints[architecture] + "?action=" + action + "&req=" + current + "&timestamp=" + timestamp;
                } else {
                    testUrl = endpoints[architecture] + "/db-test.php?" + testType + "_test=1&req=" + current + "&timestamp=" + timestamp;
                }

                var fetchOptions = {
                    method: "GET",
                    cache: "no-cache"
                };

                if (corsSupport[architecture] === false) {
                    fetchOptions.mode = "no-cors";
                } else {
                    fetchOptions.headers = {
                        "Accept": "application/json, */*"
                    };
                }

                var response = await fetch(testUrl, fetchOptions);

                var responseTime = Math.round(performance.now() - startTime);
                
                // Mise √† jour des m√©triques
                metrics[architecture].requests++;
                metrics[architecture].totalTime += responseTime;
                metrics[architecture].totalCost += costPerRequest[architecture];
                updateCounters(architecture);
                
                if (current % 10 === 0 || current === total) {
                    updateTestProgress(architecture, current, total, testType);
                }

            } catch (error) {
                var responseTime = Math.round(performance.now() - startTime);
                metrics[architecture].requests++;
                if (!error.name || error.name !== "AbortError") {
                    metrics[architecture].errors++;
                }
                metrics[architecture].totalTime += responseTime;
                metrics[architecture].totalCost += costPerRequest[architecture];
                updateCounters(architecture);
                
                if (current % 10 === 0 || current === total) {
                    updateTestProgress(architecture, current, total, testType);
                }
            }
        }

        function updateTestProgress(architecture, current, total, testType) {
            var resultsDiv = document.getElementById(architecture + "-results");
            var avgTime = metrics[architecture].requests > 0 ? 
                Math.round(metrics[architecture].totalTime / metrics[architecture].requests) : 0;
            
            if (current === total) {
                var testLabel = testType === "extended" ? "Test CloudWatch 5min" : "Load test";
                
                resultsDiv.className = "results success-box";
                resultsDiv.textContent = "‚úÖ " + testLabel + " termin√© sur " + architecture + "\n" +
total + " requ√™tes envoy√©es\n" +
"Temps moyen: " + avgTime + "ms\n" +
"Erreurs: " + metrics[architecture].errors + "\n" +
"Co√ªt total: " + metrics[architecture].totalCost.toFixed(6) + "‚Ç¨\n\n" +
"üìä M√©triques CloudWatch g√©n√©r√©es:\n" +
"- " + total + " points de donn√©es pour le temps de r√©ponse\n" +
"- " + total + " connexions base de donn√©es\n" +
"- " + (testType === "extended" ? "M√©triques continues sur 5 minutes" : "Pics de charge visibles dans le dashboard") + "\n\n" +
"‚è±Ô∏è Consultez CloudWatch dans 1-2 minutes pour voir les r√©sultats";
            } else {
                var testLabel = testType === "extended" ? "Test CloudWatch" : "Load test";
                resultsDiv.textContent = "üöÄ " + testLabel + " en cours sur " + architecture + "\n" +
"Progression: " + current + "/" + total + " requ√™tes\n" +
"Temps moyen actuel: " + avgTime + "ms\n" +
"Erreurs: " + metrics[architecture].errors + "\n" +
"Co√ªt en cours: " + metrics[architecture].totalCost.toFixed(6) + "‚Ç¨\n" +
(testType === "extended" ? "G√©n√©ration continue de m√©triques CloudWatch..." : "M√©triques en cours de g√©n√©ration...");
            }
        }

        // Tests comparatifs
        async function comparativeTest() {
            var confirmed = confirm("üöÄ D√©marrage du test comparatif rapide !\n\n" +
"‚Ä¢ 100 requ√™tes sur l'architecture classique\n" +
"‚Ä¢ 100 requ√™tes sur l'architecture serverless\n" +  
"‚Ä¢ M√™me charge sur les deux bases de donn√©es\n\n" +
"‚è±Ô∏è Dur√©e estim√©e : 5 secondes\n" +
"üìä M√©triques visibles dans CloudWatch dans 1-2 minutes\n\n" +
"Continuer ?");

            if (!confirmed) return;

            resetMetrics();
            document.getElementById("comp-test-btn").disabled = true;
            document.getElementById("comp-ext-btn").disabled = true;
            
            setTimeout(function() { loadTestDB("classic"); }, 0);
            setTimeout(function() { loadTestDB("serverless"); }, 100);
            
            setTimeout(function() {
                document.getElementById("comp-test-btn").disabled = false;
                document.getElementById("comp-ext-btn").disabled = false;
            }, 60000);
        }

        async function comparativeExtendedTest() {
            var confirmed = confirm("üïí D√©marrage du test comparatif CloudWatch !\n\n" +
"‚Ä¢ 60 requ√™tes sur 5 minutes pour l'architecture classique\n" +
"‚Ä¢ 60 requ√™tes sur 5 minutes pour l'architecture serverless\n" +
"‚Ä¢ M√©triques continues pour CloudWatch\n\n" +
"‚è±Ô∏è Dur√©e totale : 10 minutes\n" +
"üìä M√©triques optimales dans CloudWatch\n\n" +
"Continuer ?");

            if (!confirmed) return;

            resetMetrics();
            document.getElementById("comp-test-btn").disabled = true;
            document.getElementById("comp-ext-btn").disabled = true;
            
            setTimeout(function() { extendedLoadTest("classic"); }, 0);
            setTimeout(function() { extendedLoadTest("serverless"); }, 30000);
            
            setTimeout(function() {
                document.getElementById("comp-test-btn").disabled = false;
                document.getElementById("comp-ext-btn").disabled = false;
            }, 600000);
        }

        // Reset des compteurs
        function resetMetrics() {
            metrics.classic = { requests: 0, totalTime: 0, errors: 0, totalCost: 0 };
            metrics.serverless = { requests: 0, totalTime: 0, errors: 0, totalCost: 0 };
            updateCounters("classic");
            updateCounters("serverless");
        }

        // Test de connectivit√© au d√©marrage
        async function testConnectivity() {
            console.log("üîç Test de connectivit√© des endpoints...");
            
            // Test des deux architectures en parall√®le
            await Promise.all([
                testCORS("classic"),
                testCORS("serverless")
            ]);
            
            // V√©rification finale de connectivit√©
            for (var arch of ["classic", "serverless"]) {
                if (corsSupport[arch] === null) {
                    connectivity[arch] = false;
                    document.getElementById(arch + "-section").classList.add("disabled");
                    document.getElementById(arch + "-test-btn").disabled = true;
                    document.getElementById(arch + "-load-btn").disabled = true;
                    document.getElementById(arch + "-ext-btn").disabled = true;
                    document.getElementById(arch + "-results").textContent = "‚ùå Architecture " + arch + " non disponible";
                    document.getElementById(arch + "-results").className = "results error-box";
                }
            }
        }

        // Initialisation
        window.addEventListener("load", function() {
            console.log("üóÑÔ∏è Testeur de base de donn√©es AWS initialis√©");
            console.log("üìä Les tests vont g√©n√©rer des m√©triques CloudWatch r√©elles");
            console.log("üí° Utilisez les tests 5min pour des donn√©es CloudWatch optimales");
            console.log("üí∞ Co√ªts r√©alistes - Classique: " + (costPerRequest.classic * 1000).toFixed(4) + "‚Ç¨ pour 1000 requ√™tes");
            console.log("üí∞ Co√ªts r√©alistes - Serverless: " + (costPerRequest.serverless * 1000).toFixed(4) + "‚Ç¨ pour 1000 requ√™tes");
            
            // Mise √† jour de l'affichage des endpoints
            document.getElementById("classic-endpoint").textContent = 
                endpoints.classic + "/ (avec param√®tres test)";
            document.getElementById("serverless-endpoint").textContent = 
                endpoints.serverless;
            
            console.log("Endpoints configur√©s:", endpoints);
            
            // Test de connectivit√© et CORS
            testConnectivity();
            
            // V√©rification de l'environnement
            if (location.protocol === "file:") {
                document.querySelector(".info-box").innerHTML += 
                    "<br><strong>‚ö†Ô∏è Attention:</strong> Vous utilisez le protocol file://. " +
                    "Pour √©viter les probl√®mes CORS, servez cette page via HTTP/HTTPS.";
            }
        });

        // Gestion des erreurs globales
        window.addEventListener("unhandledrejection", function(event) {
            console.error("Promesse rejet√©e:", event.reason);
            if (event.reason.message && event.reason.message.includes("fetch")) {
                console.log("üí° Conseil: Probl√®me de fetch d√©tect√©. Auto-d√©tection CORS en cours...");
            }
        });

        // Debug: Afficher les informations de l'environnement
        console.log("üåç Environnement:", {
            userAgent: navigator.userAgent,
            protocol: location.protocol,
            hostname: location.hostname,
            port: location.port
        });
    </script>
</body>
</html>